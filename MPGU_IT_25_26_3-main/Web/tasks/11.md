## Web 12. Основы PostgreSQL (максимальный балл 10, дедлай 25.11.2025 включительно)

## Критерии оценки (максимум 10 баллов)

| №     | Критерий                                                | Что оценивается                                                                                                                                                | Баллы   |
| ----- | ------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| **1** | **Задание 1**                    | Задание выполнено верно | **2** |
| **2** | **Задание 2**                    | Задание выполнено верно | **2** |
| **3** | **Задание 3**                    | Задание выполнено верно | **2** |
| **4** | **Задание 4**                    | Задание выполнено верно | **2** |
| **4** | **Задание 5**                    | Задание выполнено верно | **2** |

---

### ⚠️ Штрафы за стиль (до –2 баллов суммарно)

* Смешанный регистр ключевых слов (`create TABLE` вместо `CREATE TABLE`) — −0.5
* Отсутствие отступов или переносов строк — −0.5
* CamelCase в именах таблиц/колонок — −0.5
* Отсутствие `;` в конце операторов — −0.5

---

<details>
<summary><strong style="font-size: 16px;">Вариант 1</strong></summary>

# Данные

```sql
-- Схема
DROP TABLE IF EXISTS orders;
CREATE TABLE orders (
  order_id       SERIAL PRIMARY KEY,
  order_date     DATE        NOT NULL,
  region          TEXT        NOT NULL CHECK (region IN ('North', 'South', 'East', 'West')),
  channel         TEXT        NOT NULL CHECK (channel IN ('online', 'store', 'partner')),
  payment_method  TEXT        NOT NULL CHECK (payment_method IN ('card', 'cash', 'transfer')),
  status          TEXT        NOT NULL CHECK (status IN ('new', 'paid', 'shipped', 'cancelled', 'returned')),
  amount          NUMERIC(10,2) NOT NULL CHECK (amount >= 0),
  shipping_fee    NUMERIC(10,2) NOT NULL DEFAULT 0 CHECK (shipping_fee >= 0),
  discount        NUMERIC(10,2) NOT NULL DEFAULT 0 CHECK (discount >= 0)
);

-- Наполнение (24 строки)
INSERT INTO orders (order_date,region,channel,payment_method,status,amount,shipping_fee,discount) VALUES
('2025-01-05','North','online','card','paid',        180, 10,  20),
('2025-01-06','North','store','cash','paid',         220,  0,  15),
('2025-01-07','North','partner','transfer','shipped',260, 15,  30),
('2025-01-10','North','online','card','cancelled',   140,  0,   0),
('2025-01-12','North','store','cash','returned',     190,  0,  10),
('2025-02-03','South','online','card','paid',        120,  8,   0),
('2025-02-04','South','store','cash','paid',         210,  0,  20),
('2025-02-05','South','partner','transfer','new',    130,  5,   0),
('2025-02-08','South','online','transfer','shipped', 175, 12,  15),
('2025-02-11','South','store','card','returned',     160,  0,   5),
('2025-03-02','East','online','card','paid',         95,   9,   0),
('2025-03-03','East','store','cash','paid',          205,  0,  25),
('2025-03-04','East','partner','transfer','shipped', 240, 15,  20),
('2025-03-06','East','online','card','new',          110,  7,   0),
('2025-03-09','East','store','cash','cancelled',     180,  0,   0),
('2025-04-01','West','online','transfer','paid',     155, 10,   0),
('2025-04-02','West','store','cash','paid',          260,  0,  30),
('2025-04-03','West','partner','card','paid',        300, 20,  40),
('2025-04-05','West','online','card','shipped',      220, 12,  10),
('2025-04-07','West','store','cash','returned',      210,  0,  15),
('2025-04-10','South','partner','transfer','paid',   280, 18,  35),
('2025-04-12','North','online','card','paid',        130,  9,   0),
('2025-04-14','East','partner','card','returned',    200, 10,  20),
('2025-04-15','South','online','card','cancelled',   160,  0,   0);
```

# Задания

1. CASE в SELECT
   Выведите для каждой строки:

   * `order_id`, `status`, `region`;
   * вычислите поле `net_revenue`: для статусов `paid` и `shipped` это `amount - discount + shipping_fee`, иначе `0`;
   * добавьте категорию чека `ticket_band`:
     `low` (<=150), `mid` (151–220), `high` (>220) по значению `amount`.
     Отсортируйте по `order_date`, затем `order_id`.

2. CASE в WHERE
   Выведите «высокие» заказы по правилу: порог зависит от канала продаж:

   * `online` — > 150,
   * `store` — > 200,
   * `partner` — > 180.
     Реализуйте это одним выражением `WHERE amount > CASE WHEN ... END`. Покажите `order_id, channel, amount`.

3. Простой GROUP BY с несколькими агрегаторами
   Сгруппируйте по `region` и посчитайте:

   * количество заказов,
   * суммарный `amount`,
   * среднюю скидку `avg(discount)`,
   * максимальную стоимость доставки.
     Отсортируйте регионы по убыванию суммы.

4. GROUP BY с FILTER
   По каждому `region` посчитайте:

   * суммарную «доставленную выручку» = `sum(amount - discount + shipping_fee) FILTER (WHERE status IN ('paid','shipped'))`,
   * число возвратов = `count(*) FILTER (WHERE status = 'returned')`,
   * долю возвратов = `count(*) FILTER (WHERE status='returned')::numeric / count(*)`.
     Выведите `region`, доставленную выручку, `returns_cnt`, `return_rate`. Отсортируйте по `return_rate` убыв.

5. GROUP BY с HAVING
   По `payment_method` выведите только те методы, у которых:

   * доля возвратов > 12% **или**
   * суммарная доставленная выручка (как в задании 4) > 800.
     Используйте `HAVING` с агрегатами и/или `FILTER`. Покажите метод, общее число заказов, число возвратов и доставленную выручку.

</details>

---

<details>
<summary><strong style="font-size: 16px;">Вариант 2</strong></summary>

# Данные

```sql
-- Схема
DROP TABLE IF EXISTS trips;
CREATE TABLE trips (
  trip_id        SERIAL PRIMARY KEY,
  trip_date      DATE        NOT NULL,
  city           TEXT        NOT NULL CHECK (city IN ('Stockholm', 'Gothenburg', 'Malmo', 'Uppsala')),
  rider_type     TEXT        NOT NULL CHECK (rider_type IN ('new', 'loyal', 'corporate')),
  payment_method TEXT        NOT NULL CHECK (payment_method IN ('card', 'cash', 'wallet')),
  status         TEXT        NOT NULL CHECK (status IN ('requested', 'accepted', 'completed', 'cancelled', 'refunded')),
  distance_km    NUMERIC(5,2) NOT NULL CHECK (distance_km > 0),
  base_fare      NUMERIC(6,2) NOT NULL CHECK (base_fare >= 0),
  surge          NUMERIC(3,2) NOT NULL CHECK (surge BETWEEN 1.0 AND 2.5),
  tip            NUMERIC(5,2) NOT NULL DEFAULT 0 CHECK (tip >= 0),
  discount       NUMERIC(5,2) NOT NULL DEFAULT 0 CHECK (discount >= 0)
);

-- Наполнение (28 строк)
INSERT INTO trips (trip_date,city,rider_type,payment_method,status,distance_km,base_fare,surge,tip,discount) VALUES
('2025-01-03','Stockholm','new','card','completed',   4.2, 120, 1.2,  10,  0),
('2025-01-04','Stockholm','loyal','wallet','completed',7.8, 150, 1.0,   0, 10),
('2025-01-05','Stockholm','corporate','card','cancelled',3.1,100, 1.1,   0,  0),
('2025-01-07','Stockholm','new','cash','completed',   2.6,  90, 1.3,   5,  0),
('2025-01-10','Stockholm','loyal','card','refunded',  5.0, 140, 1.1,   0,  0),
('2025-02-02','Gothenburg','new','card','completed',  6.5, 130, 1.5,   8,  0),
('2025-02-03','Gothenburg','loyal','wallet','completed',9.4,170, 1.2,   0, 15),
('2025-02-04','Gothenburg','corporate','card','completed',11.0,220,1.1,  0,  0),
('2025-02-06','Gothenburg','new','cash','cancelled',  1.8,  80, 1.0,   0,  0),
('2025-02-09','Gothenburg','loyal','card','completed', 3.9,  95, 1.6,   4,  0),
('2025-03-01','Malmo','new','wallet','completed',     5.7, 125, 1.4,   6,  5),
('2025-03-02','Malmo','loyal','card','completed',     8.2, 160, 1.1,   0,  0),
('2025-03-03','Malmo','corporate','cash','completed', 12.6,240, 1.3,   0,  0),
('2025-03-05','Malmo','new','card','cancelled',       2.0,  85, 1.0,   0,  0),
('2025-03-07','Malmo','loyal','wallet','refunded',    6.0, 135, 1.2,   0,  0),
('2025-03-10','Uppsala','new','card','completed',     3.3,  95, 1.0,   2,  0),
('2025-03-11','Uppsala','loyal','cash','completed',   7.1, 155, 1.3,   0, 10),
('2025-03-12','Uppsala','corporate','card','completed',10.4,210,1.5,   0,  0),
('2025-03-14','Uppsala','new','wallet','cancelled',   1.5,  70, 1.0,   0,  0),
('2025-03-16','Uppsala','loyal','card','completed',   4.8, 110, 1.2,   3,  0),
('2025-04-01','Stockholm','corporate','card','completed',13.2,260,1.4,  0,  0),
('2025-04-02','Stockholm','new','wallet','completed',  6.9,145, 1.1,   5,  0),
('2025-04-03','Stockholm','loyal','card','completed',  9.0,175, 1.7,   0, 20),
('2025-04-04','Gothenburg','corporate','wallet','refunded',9.2,200,1.2, 0,  0),
('2025-04-06','Gothenburg','new','card','completed',   5.4,120, 1.8,   7,  0),
('2025-04-07','Malmo','loyal','card','completed',      7.6,150, 1.0,   0, 10),
('2025-04-08','Malmo','new','cash','completed',        3.1, 90,  1.9,  3,  0),
('2025-04-09','Uppsala','corporate','card','cancelled', 2.2,100, 1.0,  0,  0);
```

# Задания

1. CASE в SELECT
   Для каждой поездки выведите:

   * `trip_id`, `city`, `status`;
   * `net_charge`: для `completed` — `base_fare * surge + tip - discount`, иначе `0`;
   * `distance_band`: `short` (<=4 км), `mid` (4–8 км), `long` (>8 км) по `distance_km`.
     Отсортируйте по `trip_date`, затем `trip_id`.

2. CASE в WHERE
   Выведите «длинные» поездки, где порог зависит от типа пассажира:

   * `new` — > 5 км,
   * `loyal` — > 8 км,
   * `corporate` — > 10 км.
     Реализуйте одним выражением:
     `WHERE distance_km > CASE WHEN rider_type='new' THEN 5 WHEN rider_type='loyal' THEN 8 ELSE 10 END`
     Покажите `trip_id, rider_type, distance_km`.

3. Простой GROUP BY с несколькими агрегаторами
   По `city` посчитайте:

   * `trips_cnt = count(*)`,
   * `sum_distance = sum(distance_km)`,
   * `avg_surge = avg(surge)`,
   * `max_tip = max(tip)`.
     Отсортируйте города по `sum_distance` убыв.

4. GROUP BY с FILTER
   По `city` посчитайте:

   * `delivered_revenue = sum(base_fare * surge + tip - discount) FILTER (WHERE status='completed')`,
   * `cancel_cnt = count(*) FILTER (WHERE status='cancelled')`,
   * `cancel_rate = (count(*) FILTER (WHERE status='cancelled'))::numeric / count(*)`.
     Выведите `city, delivered_revenue, cancel_cnt, cancel_rate`. Отсортируйте по `cancel_rate` убыв.

5. GROUP BY с HAVING
   По `payment_method` выведите только те методы, у которых:

   * `cancel_rate > 0.15` **или**
   * `delivered_revenue > 1200`.
     Используйте `HAVING` с агрегатами и/или `FILTER`. Покажите метод, общее число поездок, число отмен и доставленную выручку.

</details>

---

<details>
<summary><strong style="font-size: 16px;">Вариант 3</strong></summary>

# Данные

```sql
-- Схема
DROP TABLE IF EXISTS views;
CREATE TABLE views (
  view_id        SERIAL PRIMARY KEY,
  view_date      DATE        NOT NULL,
  region         TEXT        NOT NULL CHECK (region IN ('Nordics', 'DACH', 'CEE', 'UK')),
  device         TEXT        NOT NULL CHECK (device IN ('mobile', 'desktop', 'tv')),
  membership     TEXT        NOT NULL CHECK (membership IN ('free', 'standard', 'premium')),
  content_type   TEXT        NOT NULL CHECK (content_type IN ('movie', 'series', 'live')),
  status         TEXT        NOT NULL CHECK (status IN ('started', 'completed', 'abandoned', 'refunded')),
  minutes        INT         NOT NULL CHECK (minutes > 0),
  base_price     NUMERIC(6,2) NOT NULL CHECK (base_price >= 0),
  ad_revenue     NUMERIC(6,2) NOT NULL CHECK (ad_revenue >= 0),
  discount       NUMERIC(6,2) NOT NULL CHECK (discount >= 0)
);

-- Наполнение (26 строк)
INSERT INTO views (view_date,region,device,membership,content_type,status,minutes,base_price,ad_revenue,discount) VALUES
('2025-01-03','Nordics','tv','premium','movie','completed',     118,  0,   0,   0),
('2025-01-04','Nordics','mobile','free','series','completed',    52,  0,  1.8,  0),
('2025-01-05','Nordics','desktop','standard','movie','abandoned',34,  0,  0.6,  0),
('2025-01-07','Nordics','mobile','free','live','completed',      45,  0,  2.2,  0),
('2025-01-10','Nordics','tv','standard','movie','refunded',      95,  6.99,0.0, 1.00),

('2025-02-01','DACH','tv','premium','movie','completed',        131,  0,   0,   0),
('2025-02-02','DACH','desktop','free','series','abandoned',      22,  0,  0.9,  0),
('2025-02-03','DACH','mobile','standard','live','completed',     60,  0,  0.5,  0),
('2025-02-05','DACH','tv','standard','movie','completed',       102,  4.99,0.0, 1.00),
('2025-02-08','DACH','mobile','free','movie','completed',        70,  0,  2.5,  0),
('2025-02-09','DACH','desktop','premium','series','completed',   47,  0,   0,   0),

('2025-03-02','CEE','mobile','free','series','completed',        51,  0,  1.6,  0),
('2025-03-03','CEE','desktop','standard','movie','completed',    94,  3.99,0.0, 0.50),
('2025-03-04','CEE','tv','premium','movie','completed',         123,  0,   0,   0),
('2025-03-06','CEE','mobile','free','live','abandoned',          18,  0,  0.7,  0),
('2025-03-09','CEE','desktop','standard','series','refunded',    40,  0,  0.0,  0),

('2025-04-01','UK','tv','premium','movie','completed',          142,  0,   0,   0),
('2025-04-02','UK','desktop','free','series','completed',        58,  0,  1.9,  0),
('2025-04-03','UK','mobile','standard','movie','completed',      88,  5.99,0.0, 1.00),
('2025-04-04','UK','tv','standard','live','completed',           72,  0,  0.4,  0),
('2025-04-06','UK','mobile','free','movie','started',            12,  0,  0.5,  0),
('2025-04-07','UK','desktop','premium','series','completed',     49,  0,   0,   0),

('2025-04-10','Nordics','tv','standard','movie','completed',    100,  4.99,0.0, 0.50),
('2025-04-12','DACH','mobile','free','live','completed',         38,  0,  1.1,  0),
('2025-04-14','CEE','desktop','standard','movie','abandoned',    41,  2.99,0.0, 0.00),
('2025-04-15','UK','mobile','free','series','completed',         55,  0,  1.5,  0);
```

# Задания

1. CASE в SELECT
   Для каждой сессии выведите:

   * `view_id`, `region`, `status`;
   * `net_revenue` по правилу:

     * если `status='completed'` → `base_price - discount + ad_revenue`;
     * если `status='refunded'` → `0`;
     * иначе (started/abandoned) → только `ad_revenue`;
   * `length_band` по `minutes`: `short` (<=30), `mid` (31–60), `long` (>60).
     Отсортируйте по `view_date`, затем `view_id`.

2. CASE в WHERE
   Выведите «длинные просмотры» с порогом, зависящим от `content_type`:

   * `movie` — > 60 минут,
   * `series` — > 45 минут,
   * `live` — > 30 минут.
     Реализуйте одним выражением:
     `WHERE minutes > CASE WHEN content_type='movie' THEN 60 WHEN content_type='series' THEN 45 ELSE 30 END`
     Покажите `view_id, content_type, minutes`.

3. Простой GROUP BY с несколькими агрегаторами
   По `region` посчитайте:

   * `sessions = count(*)`,
   * `sum_minutes = sum(minutes)`,
   * `avg_ads = avg(ad_revenue)`,
   * `max_price = max(base_price)`.
     Отсортируйте по `sum_minutes` убыв.

4. GROUP BY с FILTER
   По `region` посчитайте:

   * `delivered_revenue = sum(base_price - discount + ad_revenue) FILTER (WHERE status='completed')`,
   * `refund_cnt = count(*) FILTER (WHERE status='refunded')`,
   * `refund_rate = (count(*) FILTER (WHERE status='refunded'))::numeric / count(*)`.
     Выведите `region, delivered_revenue, refund_cnt, refund_rate`. Отсортируйте по `refund_rate` убыв.

5. GROUP BY с HAVING
   По `membership` выведите только те тарифы, у которых:

   * `refund_rate > 0.08` **или**
   * `delivered_revenue > 12` (в условных единицах таблицы).
     Используйте `HAVING` с агрегатами и/или `FILTER`. Покажите тариф, общее число сессий, число возвратов и доставленную выручку.

</details>

---

<details>
<summary><strong style="font-size: 16px;">Вариант 4</strong></summary>

# Данные

```sql
-- Схема
DROP TABLE IF EXISTS deliveries;
CREATE TABLE deliveries (
  delivery_id     SERIAL PRIMARY KEY,
  delivery_date   DATE         NOT NULL,
  city            TEXT         NOT NULL CHECK(city in ('Stockholm', 'Gothenburg', 'Malmo', 'Uppsala')),
  platform        TEXT         NOT NULL CHECK(platform in ('ios', 'android', 'web')),
  cuisine         TEXT         NOT NULL CHECK(cuisine in ('pizza', 'sushi', 'burger', 'salad', 'indian')),
  payment_method  TEXT         NOT NULL CHECK(payment_method in ('card', 'cash', 'wallet')),
  status          TEXT         NOT NULL CHECK(status in ('placed', 'accepted', 'delivered', 'cancelled', 'refunded')),
  items_count     INT          NOT NULL,
  subtotal        NUMERIC(7,2) NOT NULL,   -- сумма блюд
  delivery_fee    NUMERIC(6,2) NOT NULL,   -- доставка
  tip             NUMERIC(6,2) NOT NULL DEFAULT 0,
  discount        NUMERIC(6,2) NOT NULL DEFAULT 0
);

-- Наполнение (28 строк)
INSERT INTO deliveries (delivery_date,city,platform,cuisine,payment_method,status,items_count,subtotal,delivery_fee,tip,discount) VALUES
('2025-01-03','Stockholm','ios','pizza','card','delivered',      2, 220,  39, 20,  0),
('2025-01-04','Stockholm','android','sushi','wallet','delivered',3, 275,  29,  0, 25),
('2025-01-05','Stockholm','web','burger','card','cancelled',     1, 120,  19,  0,  0),
('2025-01-07','Stockholm','ios','salad','cash','delivered',      2, 160,  29, 10,  0),
('2025-01-10','Stockholm','web','sushi','card','refunded',       4, 340,  39,  0, 40),

('2025-02-02','Gothenburg','ios','burger','card','delivered',    3, 240,  29, 15,  0),
('2025-02-03','Gothenburg','android','pizza','wallet','delivered',2, 185,  29,  0, 10),
('2025-02-04','Gothenburg','web','indian','card','delivered',    4, 320,  39,  0,  0),
('2025-02-06','Gothenburg','ios','salad','cash','cancelled',     1,  95,  19,  0,  0),
('2025-02-09','Gothenburg','android','sushi','card','delivered', 2, 210,  29,  8,  0),

('2025-03-01','Malmo','web','pizza','wallet','delivered',        3, 265,  39,  5,  0),
('2025-03-02','Malmo','ios','burger','card','delivered',         2, 190,  29,  0,  0),
('2025-03-03','Malmo','android','sushi','cash','delivered',      4, 330,  39,  0, 20),
('2025-03-05','Malmo','web','salad','card','cancelled',          1,  85,  19,  0,  0),
('2025-03-07','Malmo','ios','indian','wallet','refunded',        3, 280,  29,  0,  0),

('2025-03-10','Uppsala','ios','pizza','card','delivered',        2, 210,  29,  6,  0),
('2025-03-11','Uppsala','android','burger','cash','delivered',   3, 235,  29,  0, 15),
('2025-03-12','Uppsala','web','sushi','card','delivered',        4, 345,  39,  0,  0),
('2025-03-14','Uppsala','ios','salad','wallet','cancelled',      1,  92,  19,  0,  0),
('2025-03-16','Uppsala','android','indian','card','delivered',   2, 195,  29,  4,  0),

('2025-04-01','Stockholm','web','pizza','card','delivered',      4, 360,  39,  0,  0),
('2025-04-02','Stockholm','ios','sushi','wallet','delivered',    2, 225,  29, 12,  0),
('2025-04-03','Stockholm','android','burger','card','delivered', 3, 255,  29,  0, 20),
('2025-04-04','Gothenburg','web','indian','wallet','refunded',   2, 210,  29,  0,  0),
('2025-04-06','Gothenburg','ios','pizza','card','delivered',     2, 200,  29,  7,  0),
('2025-04-07','Malmo','android','salad','card','delivered',      2, 170,  29,  0, 10),
('2025-04-08','Malmo','web','burger','cash','delivered',         3, 245,  39,  3,  0),
('2025-04-09','Uppsala','ios','sushi','card','cancelled',        1, 110,  19,  0,  0);
```

# Задания

1. CASE в SELECT
   Для каждой доставки выведите:

   * `delivery_id`, `city`, `status`;
   * `net_revenue`: для `delivered` → `subtotal - discount + delivery_fee + tip`, иначе `0`;
   * `ticket_band` по `subtotal`: `low` (<=200), `mid` (201–300), `high` (>300).
     Отсортируйте по `delivery_date`, затем `delivery_id`.

2. CASE в WHERE
   Выведите «дорогие заказы» с порогом, зависящим от платформы:

   * `ios` — > 200,
   * `android` — > 220,
   * `web` — > 250.
     Реализуйте одним выражением:
     `WHERE subtotal > CASE WHEN platform='ios' THEN 200 WHEN platform='android' THEN 220 ELSE 250 END`
     Покажите `delivery_id, platform, subtotal`.

3. Простой GROUP BY с несколькими агрегаторами
   По `city` посчитайте:

   * `orders_cnt = count(*)`,
   * `sum_subtotal = sum(subtotal)`,
   * `avg_fee = avg(delivery_fee)`,
   * `max_tip = max(tip)`.
     Отсортируйте по `sum_subtotal` убыв.

4. GROUP BY с FILTER
   По `city` посчитайте:

   * `delivered_revenue = sum(subtotal - discount + delivery_fee + tip) FILTER (WHERE status='delivered')`,
   * `refund_cnt = count(*) FILTER (WHERE status='refunded')`,
   * `cancel_rate = (count(*) FILTER (WHERE status='cancelled'))::numeric / count(*)`.
     Выведите `city, delivered_revenue, refund_cnt, cancel_rate`. Отсортируйте по `cancel_rate` убыв.

5. GROUP BY с HAVING
   По `cuisine` выведите только те кухни, у которых:

   * `cancel_rate > 0.12` **или**
   * `delivered_revenue > 1000`.
     Используйте `HAVING` с агрегатами и/или `FILTER`. Покажите кухню, общее число заказов, число отмен и доставленную выручку.

</details>

---

<details>
<summary><strong style="font-size: 16px;">Вариант 5</strong></summary>

# Данные

```sql
-- Схема
DROP TABLE IF EXISTS quests;
CREATE TABLE quests (
  quest_id         SERIAL PRIMARY KEY,
  quest_date       DATE         NOT NULL,
  realm            TEXT         NOT NULL CHECK(realm in ('Valoria', 'Nordheim', 'Sandsea', 'Blackreach')),
  player_class     TEXT         NOT NULL CHECK(realm in ('warrior', 'mage', 'rogue', 'cleric')),
  mode             TEXT         NOT NULL CHECK(realm in ('solo', 'party')),
  quest_type       TEXT         NOT NULL CHECK(realm in ('hunt', 'escort', 'dungeon', 'bounty')),
  difficulty       INT          NOT NULL,  -- 1..5
  status           TEXT         NOT NULL CHECK(realm in ('accepted', 'completed', 'failed', 'abandoned', 'cancelled')),abandoned / cancelled
  reward_gold      NUMERIC(7,2) NOT NULL,
  reward_xp        INT          NOT NULL,
  consumables_cost NUMERIC(7,2) NOT NULL DEFAULT 0,  -- зелья, свитки и т. п.
  fine             NUMERIC(7,2) NOT NULL DEFAULT 0   -- штрафы гильдии/заказчика
);

-- Наполнение (28 строк)
INSERT INTO quests
(quest_date,realm,player_class,mode,quest_type,difficulty,status,reward_gold,reward_xp,consumables_cost,fine) VALUES
('2025-01-03','Valoria','warrior','solo','hunt',      3,'completed', 180, 300,  20,  0),
('2025-01-04','Valoria','mage','party','dungeon',     4,'completed', 260, 520,  35,  0),
('2025-01-05','Valoria','rogue','solo','bounty',      2,'cancelled',  90, 120,   0,  0),
('2025-01-07','Valoria','cleric','solo','escort',     2,'completed', 140, 260,  10,  0),
('2025-01-10','Valoria','warrior','party','dungeon',  5,'failed',    340, 700,  45, 30),

('2025-02-01','Nordheim','mage','party','dungeon',    5,'completed', 320, 680,  50,  0),
('2025-02-02','Nordheim','rogue','solo','bounty',     3,'completed', 170, 310,  15,  0),
('2025-02-03','Nordheim','cleric','party','escort',   3,'completed', 150, 280,  12,  0),
('2025-02-05','Nordheim','warrior','solo','hunt',     2,'abandoned', 110, 150,  10,  0),
('2025-02-08','Nordheim','mage','solo','hunt',        4,'completed', 210, 380,  25,  0),

('2025-03-01','Sandsea','rogue','solo','bounty',      4,'completed', 220, 420,  18,  0),
('2025-03-02','Sandsea','cleric','party','escort',    2,'completed', 120, 200,   8,  0),
('2025-03-03','Sandsea','warrior','party','dungeon',  5,'completed', 360, 750,  55,  0),
('2025-03-05','Sandsea','mage','solo','hunt',         3,'failed',    160, 300,  22, 15),
('2025-03-07','Sandsea','rogue','solo','bounty',      1,'completed',  80, 120,   5,  0),

('2025-03-10','Blackreach','warrior','party','dungeon',5,'completed', 400, 820,  60,  0),
('2025-03-11','Blackreach','mage','solo','hunt',      2,'completed', 130, 240,  12,  0),
('2025-03-12','Blackreach','rogue','party','bounty',  3,'completed', 190, 350,  16,  0),
('2025-03-14','Blackreach','cleric','solo','escort',  3,'abandoned', 135, 230,   9,  0),
('2025-03-16','Blackreach','warrior','solo','hunt',   4,'completed', 210, 390,  27,  0),

('2025-04-01','Valoria','rogue','party','dungeon',    4,'completed', 280, 560,  40,  0),
('2025-04-02','Valoria','cleric','solo','escort',     1,'completed',  75, 110,   4,  0),
('2025-04-03','Nordheim','warrior','party','dungeon', 5,'failed',    350, 720,  58, 25),
('2025-04-04','Nordheim','mage','solo','hunt',        3,'completed', 175, 330,  18,  0),
('2025-04-06','Sandsea','cleric','party','escort',    2,'cancelled', 115, 180,   0,  0),
('2025-04-07','Sandsea','warrior','solo','hunt',      4,'completed', 205, 370,  24,  0),
('2025-04-08','Blackreach','rogue','solo','bounty',   3,'completed', 185, 340,  14,  0),
('2025-04-09','Blackreach','mage','party','dungeon',  5,'completed', 390, 800,  62,  0);
```

# Задания

1. CASE в SELECT
   Для каждой записи выведите:

   * `quest_id`, `realm`, `status`;
   * `net_gold`: если `status='completed'` → `reward_gold - consumables_cost - fine`, иначе `0`;
   * `diff_band` по `difficulty`: `easy` (1–2), `mid` (3–4), `hard` (5).
     Отсортируйте по `quest_date`, затем `quest_id`.

2. CASE в WHERE
   Выведите «сложные для выбранного режима» квесты, где порог зависит от `mode`:

   * для `solo` — `difficulty > 3`,
   * для `party` — `difficulty > 4`.
     Реализуйте одним выражением:

   ```
   WHERE difficulty > CASE WHEN mode='solo' THEN 3 ELSE 4 END
   ```

   Покажите `quest_id, mode, difficulty`.

3. Простой GROUP BY с несколькими агрегаторами
   По `realm` посчитайте:

   * `q_cnt = count(*)`,
   * `sum_gold = sum(reward_gold)`,
   * `avg_xp = avg(reward_xp)`,
   * `max_diff = max(difficulty)`.
     Отсортируйте по `sum_gold` убыв.

4. GROUP BY с FILTER
   По `player_class` посчитайте:

   * `completed_gold = sum(reward_gold - consumables_cost - fine) FILTER (WHERE status='completed')`,
   * `fail_cnt = count(*) FILTER (WHERE status='failed')`,
   * `fail_rate = (count(*) FILTER (WHERE status='failed'))::numeric / count(*)`.
     Выведите `player_class, completed_gold, fail_cnt, fail_rate`. Отсортируйте по `fail_rate` убыв.

5. GROUP BY с HAVING
   По `quest_type` выведите только те типы, у которых:

   * `fail_rate > 0.20` **или**
   * `completed_gold > 800`.
     Используйте `HAVING` с агрегатами и/или `FILTER`. Покажите тип, общее число квестов, число провалов и суммарное золото за выполненные.

6. Комбинированная (усложнение)
   По паре `(realm, mode)` посчитайте:

   * `unique_days = count(DISTINCT quest_date)`,
   * `avg_completed_net = avg(reward_gold - consumables_cost - fine) FILTER (WHERE status='completed')`,
   * `hard_share = avg((difficulty > CASE WHEN mode='solo' THEN 3 ELSE 4 END)::int)`.
     Покажите только пары, где было **минимум 2 неуспешных попытки**
     (`HAVING count(*) FILTER (WHERE status IN ('failed','abandoned')) >= 2`),
     и отсортируйте по `avg_completed_net` убыв.

</details>

---
